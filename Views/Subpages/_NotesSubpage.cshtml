@using System;
@using Helium24.Definitions;

@{
    Layout = "Layouts/SubpageLayout.cshtml";

    // View items and the URLs
    string notepadLoadingStatus = "notepadLoadingStatus";
    string notepadLastEditDate = "notepadLastEditDate";
    string notepadLoadLastIteration = "notepadLoadLastIteration";
    string notepadEditSaveButton = "notepadEditSaveButton";
    string notepadEditSaveStatus = "notepadEditSaveStatus";

    string urlNotes = "/Notes/CurrentNotes";
    string urlLastNotes = "/Notes/LastNotes";
}

@section StyleSheets {
    <link rel="stylesheet" href="~/Content/NotesStyles.css">
    <style type="text/css" media="screen">
        #editorSettings {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
}

@section Content{
    <div class="card" style="width: 40rem;">
        <div class="card-header">
            Notes <small><span class="text-muted" id="@notepadLastEditDate"></span></small>
        </div>
        <div class="card-body">
            <div class="editorSettings" id="editor">// Enter notes here</div>
        </div>
        <div class="card-footer">
            <div class="row justify-content-between">
                <div class="col-auto">
                    <button id="@notepadEditSaveButton" type="button" class="btn btn-secondary btn-sm">Save</button>
                    <button id="@notepadLoadLastIteration" type="button" class="btn btn-danger btn-sm">Rollback</button>
                </div>
                <div class="col-auto">
                    <span class="alert-warning" role="alert" id="@notepadLoadingStatus"></span>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts{
    <script type="text/javascript" src="~/Content/ace-1.2.9/ace.js"></script>
    <script type="text/javascript" src="~/Content/es6-promise-auto-4.2/es6-promise.auto.min.js"></script>
    <script type="text/javascript" src="~/Content/axios-0.17/axios.min.js"></script>

    <!-- Enable the nice, fancy editor. -->
    <script type="text/javascript">

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/chrome");
        editor.session.setMode("ace/mode/text");
        editor.session.setUseWorker(false);

        // Save the edits when requested
        $("#@notepadEditSaveButton").click(function () {
            $("#@notepadEditSaveStatus").text("Saving...");

            $.ajax({
                url: '@urlNotes',
                type: 'POST',
                data: editor.getValue(),
                dataType: 'text',
                success: function (data) {
                    $("#@notepadEditSaveStatus").text(data);
                },
                error: function (data) {
                    $("#@notepadEditSaveStatus").text(data.responseText);
                }
            });
        });

        // Load with the last iteration when requested
        $("#@notepadLoadLastIteration").click(function () {
            $("#@notepadLoadingStatus").text("Loading last iteration...");

            $.ajax({
                url: '@urlLastNotes',
                type: 'GET',
                data: editor.getValue(),
                dataType: 'text',
                success: function (data) {
                    editor.setValue(data);
                    $("#@notepadLoadingStatus").text("Last iteration loaded successfully!");
                },
                error: function (data) {
                    $("#@notepadLoadingStatus").text(data.responseText);
                }
            });
        });

        // Runs at startup to load the user's notes.
        function loadUserNotes() {
            axios.get('@urlNotes')
                .then(function (data) {
                    editor.session.setValue(data.data.notes);
                    $("#@notepadLastEditDate").text("Last edited on: " + data.data.lastEditDate);
                    $("#@notepadLoadingStatus").text("Successful notepad loading!");
                })
                .catch(function (data) {
                    $("#@notepadLoadingStatus").text(data);
                });
        }

        $(document).ready(function () {
            loadUserNotes();
        });
    </script>
}