@using System;
@using Helium24.Definitions;

@{
    Layout = "Layouts/SubpageLayout.cshtml";
    
    // View items and the URLs
    string minDate = "minDate";
    string maxDate = "maxDate";
    string minDateValue = (DateTime.UtcNow - TimeSpan.FromDays(1)).ToString("yyyy-MM-dd hh:mm:ss");
    string maxDateValue = DateTime.UtcNow.ToString("yyyy-MM-dd hh:mm:ss");
    string getHistoricalImages = "getHistoricalImages";
    string deleteButton = "deleteImage";
    string historicalImagesTable = "historicalImages";

    string cameraUpdateRateInSeconds = "cameraUpdateRateInSeconds";
    string cameraRateUpdateButton = "cameraRateUpdateButton";
    string cameraOneImage = "cameraOneImage";
    string cameraThreeImage = "cameraThreeImage";

    string cameraOneTemp = "cameraOneTemp";
    string cameraOnePower = "cameraOnePower";
    string cameraOneVoltage = "cameraOneVoltage";

    string cameraThreeTemp = "cameraThreeTemp";
    string cameraThreePower = "cameraThreePower";
    string cameraThreeVoltage = "cameraThreeVoltage";

    string urlCameraOne = "/Cameras/One";
    string urlCameraOneSensors = "/Cameras/OneSensors";
    string urlCameraThree = "/Cameras/Three";
    string urlCameraThreeSensors = "/Cameras/ThreeSensors";
    string urlQuery = "/Cameras/Query";
    string urlDelete = "/Cameras/Query/Image";
}

@section StyleSheets {
    <link rel="stylesheet" href="~/Content/CameraStyles.css">
}

@section Content{
    <div class="row">
        <div class="col">
            <div class="card" style="width: 40rem;">
                <div class="card-header">Camera I</div>
                <div class="card-body">
                    <img id="@cameraOneImage" width="576" height="432"  alt="Camera I image loading..." />
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col">
                            <span id="@cameraOneTemp"></span> °C / °F <br />
                        </div>
                        <div class="col">
                            <span id="@cameraOnePower"></span> % &#x26A1 <br />
                        </div>
                        <div class="col">
                            <span id="@cameraOneVoltage"></span> V <br />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card" style="width: 40rem;">
                <div class="card-header">Camera III</div>
                <div class="card-body">
                    <img id="@cameraThreeImage" width="576" height="432" alt="Camera III image loading..."/>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col">
                            <span id="@cameraThreeTemp"></span> °C / °F <br />
                        </div>
                        <div class="col">
                            <span id="@cameraThreePower"></span> % &#x26A1 <br />
                        </div>
                        <div class="col">
                            <span id="@cameraThreeVoltage"></span> V <br />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">Settings</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            Update every <input id="@cameraUpdateRateInSeconds" type="number" value="600" /> seconds.
                        </div>
                        <div class="col">
                            <button id="@cameraRateUpdateButton" type="button">Update Now</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card" style="width: 35rem;">
                <div class="card-header">Archive</div>
                <div class="card-body">
                    <i>Min Date<input id="@minDate" type="text" value="@minDateValue" /></i>
                    <br /><i>Max Date<input id="@maxDate" type="text" value="@maxDateValue" /></i>
                    <br /><button id="@getHistoricalImages" type="button">Run Query</button>
                    <table id="@historicalImagesTable" style="border: 1px solid; background: #f9ffc2; min-width: 600px;">
                        <tr>
                            <th>Date</th>
                            <th>Camera ID</th>
                            <th>Image</th>
                            <th>Delete?</th>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts{
    <script type="text/javascript" src="~/Content/Scripts/jquery-2.1.4.js"></script>

    <!-- Show camera-->
    <script type="text/javascript">
            var cameraUpdateTimerId = 0;

            function loadCameraImage(url, imageId) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    cache: false,
                    processData: false,
                }).always(function (b64data) {
                    $("#" + imageId).attr("src", "data:image/jpeg;base64," + b64data);
                });
            }

            function loadCameraStats(url, temp, power, voltage) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    cache: false,
                    success: function (data) {
                        data = JSON.parse(data);

                        var batteryTempC = data.battery_temp.data[0][1][0];
                        var batteryTempF = batteryTempC * (9.0 / 5.0) + 32;

                        // Loads the camera status for temp, power, and voltage.
                        $("#" + temp).text(batteryTempC.toFixed(2) + " / " + batteryTempF.toFixed(2));
                        $("#" + power).text(data.battery_level.data[0][1]);
                        $("#" + voltage).text(data.battery_voltage.data[0][1]);
                    },
                    error: function (data) {
                        $("#" + temp).text(data.responseText);
                    }
                });
            }

            function loadCameraImagesAndStats() {
                loadCameraImage("@urlCameraOne", "@cameraOneImage");
                loadCameraImage("@urlCameraThree", "@cameraThreeImage");

                loadCameraStats("@urlCameraOneSensors", "@cameraOneTemp", "@cameraOnePower", "@cameraOneVoltage");
                loadCameraStats("@urlCameraThreeSensors", "@cameraThreeTemp", "@cameraThreePower", "@cameraThreeVoltage");
            }

            function startCameraSequence() {
                loadCameraImagesAndStats();
                cameraUpdateTimerId = setInterval("loadCameraImagesAndStats()", 1000 * $("#@cameraUpdateRateInSeconds").val());
            }

            $("#@cameraRateUpdateButton").click(function () {
                clearInterval(cameraUpdateTimerId);
                startCameraSequence();
            });

            $("body").on('click', '.@deleteButton', function () {
                var rowId = $(this).attr('data-rowid');
                var encapsulatedDate =
                {
                    CaptureTime: $(this).attr('data-imageid')
                };

                $.ajax({
                    url: '@urlDelete',
                    type: 'DELETE',
                    data: encapsulatedDate,
                    success: function (data) {
                        // Remove the image that we deleted
                        $("#" + rowId).remove();
                    },
                    error: function (data) {
                        // TODO don't leave us hanging...
                    }
                });
            });

            $("#@getHistoricalImages").click(function () {
                var dateRange =
                {
                    MinDateTime: $("#@minDate").val(),
                    MaxDateTime: $("#@maxDate").val()
                };

                $.ajax({
                    url: '@urlQuery',
                    type: 'POST',
                    data: dateRange,
                    success: function (data) {
                        // Clear our existing results
                        $("#@historicalImagesTable").find("tr:gt(0)").remove();
                        var prefix = "<td style=\"border-left: 1px dashed; border-top: 1px dashed;\">";
                        var postfix = "</td>";
                        for (var i = 0; i < data.length; i++) {
                            var date = prefix + data[i].date + postfix;
                            var cameraId = prefix + data[i].cameraId + postfix;
                            var image = prefix + "<img src=\"data:image/jpeg;base64," + data[i].image + "\" />" + postfix;
                            var deleteButton = prefix + "<button class=\"@deleteButton\" type=\"button\" data-imageid=\"" + data[i].date + "\" data-rowid=\"histTableRow" + (i + 1) + "\">Delete</button>" + postfix;
                            $("#@historicalImagesTable tr:last").after("<tr id=\"histTableRow" + (i + 1) + "\">" +
                                date + cameraId + image + deleteButton + "</tr>");
                        }
                    },
                    error: function (data) {
                        // TODO don't leave us hanging...
                    }
                });
            });

            $(document).ready(function () {
                startCameraSequence();
            });
    </script>
}
